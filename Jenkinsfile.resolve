// file: Jenkinsfile.resolve
pipeline {
    agent any

    tools {
        ansible 'ansible-latest'
    }

    parameters {
        string(name: 'TARGET_HOST', description: 'IP of the target VM')
        string(name: 'INCIDENT_TYPE', description: 'Type of incident (DISK_FULL, CPU_HIGH, MAIL_QUEUE)')
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                echo "Lấy mã nguồn từ Git..."
                checkout scm
            }
        }
        
        stage('Resolving Incident') {
            steps {
                script {
                    def incident = params.INCIDENT_TYPE.toUpperCase()
                    echo "Attempting to resolve ${incident} on host ${params.TARGET_HOST}"
                    
                    def playbook = ""
                    if (incident.contains('DISK')) {
                        playbook = 'ansible/disk_fix.yml'
                    } else if (incident.contains('CPU')) {
                        playbook = 'ansible/cpu_fix.yml'
                    } else if (incident.contains('MAIL')) {
                        playbook = 'ansible/mail_fix.yml'
                    } else {
                        error "Invalid incident type: ${params.INCIDENT_TYPE}"
                    }
                    
                    echo "Running Ansible playbook: ${playbook}"
                    
                    withEnv(['ANSIBLE_HOST_KEY_CHECKING=False']) {
                        sh """
                        ansible-playbook -i "${params.TARGET_HOST}," \\
                                         -u ubuntu \\
                                         --private-key /root/.ssh/nguyenp-key-pair.pem \\
                                         ${playbook}
                        """
                    }
                }
            }
        }
    }
}