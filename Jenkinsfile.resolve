// file: Jenkinsfile.resolve
pipeline {
    agent any
    parameters {
        string(name: 'TARGET_HOST', description: 'IP of the target VM')
        string(name: 'INCIDENT_TYPE', description: 'Type of incident (DISK_FULL, CPU_HIGH, MAIL_QUEUE)')
    }
    stages {
        stage('Resolving Incident') {
            steps {
                script {
                    // Chuyển tham số đầu vào thành chữ hoa để so sánh không phân biệt chữ hoa/thường
                    def incident = params.INCIDENT_TYPE.toUpperCase()
                    echo "Attempting to resolve ${incident} on host ${params.TARGET_HOST}"
                    
                    def playbook = ""
                    // Thay vì so sánh bằng (==), ta dùng `contains` để linh hoạt hơn
                    if (incident.contains('DISK')) {
                        playbook = 'ansible/disk_fix.yml'
                    } else if (incident.contains('CPU')) {
                        playbook = 'ansible/cpu_fix.yml'
                    } else if (incident.contains('MAIL')) {
                        playbook = 'ansible/mail_fix.yml'
                    } else {
                        error "Invalid incident type: ${params.INCIDENT_TYPE}"
                    }
                    
                    echo "Running Ansible playbook: ${playbook}"
                    
                    sh """
                    ansible-playbook -i "${params.TARGET_HOST}," \\
                                     --private-key ~/.ssh/nguyenp-key-pair.pem \\
                                     ${playbook}
                    """
                }
            }
        }
    }
}