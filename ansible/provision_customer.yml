---
- hosts: all
  become: yes
  vars:
    nagios_server_ip: "44.204.24.61"

  tasks:
    # --- PHẦN 1 & 2: GIỮ NGUYÊN ---
    - name: Cài đặt Postfix không cần hỏi
      shell: |
        debconf-set-selections <<< "postfix postfix/mailname string $(hostname -f)"
        debconf-set-selections <<< "postfix postfix/main_mailer_type string 'Internet Site'"
        apt-get install -y postfix
      args:
        warn: no
      changed_when: true

    - name: Đảm bảo dịch vụ Postfix đang chạy
      service:
        name: postfix
        state: started
        enabled: yes

    - name: Cài đặt Nagios client (NRPE) và các plugin
      apt:
        name:
          - nagios-nrpe-server
          - nagios-plugins
        state: present
        update_cache: yes

    - name: Cấu hình NRPE để cho phép Nagios Server kết nối
      template:
        src: templates/nrpe.cfg.j2
        dest: /etc/nagios/nrpe.cfg
        owner: root
        group: root
        mode: '0644'
      notify: Restart NRPE

    # --- PHẦN 3: TẠO USER 'newcust' (GIỮ NGUYÊN) ---
    - name: Tạo user 'newcust'
      ansible.builtin.user:
        name: newcust
        password: "$6$rounds=656000$yIZ4CcsgYyP.9T6C$7n2eDFOajY9pKN2vK4xEX3a/S4/DAB4PxjS9NlT2e2e9tJFrbU8bJ3UuJEqbexj3b2n8ZkksoWvjTYP745b.I/"
        shell: /bin/bash
        state: present
        create_home: yes

    - name: Thêm user 'newcust' vào nhóm sudo
      ansible.builtin.user:
        name: newcust
        groups: sudo
        append: yes

    # ====================================================================
    # SỬA LỖI CUỐI CÙNG: SỬA TRỰC TIẾP FILE CẤU HÌNH CỦA CLOUD-INIT
    # Tôi đã xóa task cũ và thay bằng task này để đảm bảo chỉ sửa đúng 1 file.
    # ====================================================================
    - name: Final override to ensure password authentication is enabled
      shell: |
        # Đợi một chút để các tiến trình cloud-init khác có thể hoàn tất
        sleep 5 
        # Dùng lệnh sed để tìm và thay thế 'PasswordAuthentication no' thành 'yes'
        sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        # Khởi động lại sshd ngay lập tức để áp dụng
        systemctl restart sshd
      changed_when: false # Tắt cảnh báo "changed" cho task này

  # Khối handlers vẫn giữ nguyên, sẽ được gọi bởi 'notify' ở trên
  handlers:
    - name: Restart NRPE
      service:
        name: nagios-nrpe-server
        state: restarted

    - name: Restart sshd
      service:
        name: sshd
        state: restarted