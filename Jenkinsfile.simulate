// file: Jenkinsfile.simulate
pipeline {
    agent any

    tools {
        ansible 'ansible-latest'
    }

    parameters {
        string(name: 'TARGET_HOST', description: 'IP của máy chủ cần giả lập sự cố', defaultValue: '3.91.186.154')
        string(name: 'INCIDENT_TYPE', description: 'Loại sự cố', defaultValue: 'CPU_HIGH')
    }

    stages {
        stage('Simulate CPU Stress') {
            steps {
                script {
                    echo "Starting CPU stress simulation on host ${params.TARGET_HOST}"
                    
                    // Lệnh Ansible này sẽ chạy một tiến trình ngầm làm tăng tải CPU
                    sh """
                    ansible all -i "${params.TARGET_HOST}," \\
                                     -u ubuntu \\
                                     --private-key /root/.ssh/nguyenp-key-pair.pem \\
                                     -m shell \\
                                     -a "nohup stress-ng --cpu 1 --cpu-load 95 --timeout 300s &"
                    """
                    // Giải thích lệnh stress-ng:
                    // --cpu 1:       Chỉ tác động lên 1 core CPU.
                    // --cpu-load 95: Đặt mục tiêu tải là 95%.
                    // --timeout 300s: Tự động dừng sau 300 giây (5 phút).
                    // nohup ... &:   Chạy tiến trình ở chế độ nền (background) và không bị tắt khi job Jenkins kết thúc.
                }
            }
        }
    }
}