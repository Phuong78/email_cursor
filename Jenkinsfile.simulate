// Jenkinsfile.simulate
pipeline {
    agent any
    parameters {
        string(name: 'TARGET_HOST', description: 'IP of the target customer VM')
        string(name: 'INCIDENT_TYPE', defaultValue: 'CPU_HIGH', description: 'Type of incident to simulate')
    }
    stages {
        stage('Simulate Incident') {
            steps {
                script {
                    echo "Simulating ${params.INCIDENT_TYPE} on host ${params.TARGET_HOST}"
                    // Sử dụng Ansible để chạy lệnh stress từ xa
                    // -i "${params.TARGET_HOST}," tạo một inventory động chỉ chứa máy chủ đích
                    sh """
                    ansible all -i "${params.TARGET_HOST}," \\
                            -u ubuntu \\
                            --private-key ~/.ssh/nguyenp-key-pair.pem \\
                            -m shell \\
                            -a "nohup stress-ng --cpu 1 --cpu-load 95 --timeout 300s &"
                    """
                    // Lệnh trên sẽ chạy ngầm (nohup &) một tiến trình làm CPU tăng 95% trong 300 giây (5 phút)
                }
            }
        }
    }
}