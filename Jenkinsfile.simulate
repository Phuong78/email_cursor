// file: Jenkinsfile.simulate
pipeline {
    agent any

    parameters {
        string(name: 'TARGET_HOST', description: 'IP c·ªßa m√°y ch·ªß c·∫ßn gi·∫£ l·∫≠p s·ª± c·ªë', defaultValue: '3.91.186.154')
        string(name: 'INCIDENT_TYPE', description: 'Lo·∫°i s·ª± c·ªë', defaultValue: 'CPU_HIGH')
    }

    stages {
        stage('Simulate CPU Stress') {
            steps {
                script {
                    echo "Starting CPU stress simulation on host ${params.TARGET_HOST}"
                    
                    // üëá B·ªåC L·ªÜNH SH TRONG KH·ªêI withEnv N√ÄY
                    withEnv(['ANSIBLE_HOST_KEY_CHECKING=False']) {
                        sh """
                        ansible all -i "${params.TARGET_HOST}," \\
                                         -u ubuntu \\
                                         --private-key /root/.ssh/nguyenp-key-pair.pem \\
                                         -m shell \\
                                         -a "nohup stress-ng --cpu 1 --cpu-load 95 --timeout 300s &"
                        """
                    }
                }
            }
        }
    }
}